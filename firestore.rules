rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get user role from their profile
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is at least Class Rep level (can create announcements)
    function isClassRepOrAbove() {
      let role = getUserRole();
      return role == 'super_admin' || role == 'admin' || role == 'faculty' || role == 'class_rep';
    }
    
    // Check if user is at least Faculty level
    function isFacultyOrAbove() {
      let role = getUserRole();
      return role == 'super_admin' || role == 'admin' || role == 'faculty';
    }
    
    // Check if user is Admin or above
    function isAdminOrAbove() {
      let role = getUserRole();
      return role == 'super_admin' || role == 'admin';
    }
    
    // Check if user is Super Admin
    function isSuperAdmin() {
      return getUserRole() == 'super_admin';
    }
    
    // ==========================================
    // USERS COLLECTION
    // ==========================================
    match /users/{userId} {
      // Anyone authenticated can read users (for user lists, etc.)
      allow read: if isAuthenticated();
      
      // Users can update their own profile (limited to non-role fields)
      allow update: if isAuthenticated() 
        && request.auth.uid == userId
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      
      // Faculty and above can create new users
      allow create: if isAuthenticated() && isFacultyOrAbove();
      
      // Faculty and above can update any user (including role changes)
      allow update: if isAuthenticated() && isFacultyOrAbove();
      
      // Only Admin and above can delete users
      allow delete: if isAuthenticated() && isAdminOrAbove();
    }
    
    // ==========================================
    // ANNOUNCEMENTS COLLECTION
    // ==========================================
    match /announcements/{announcementId} {
      // Anyone authenticated can read announcements
      // Filtering by status is done on the client side
      allow read: if isAuthenticated();
      
      // Class Rep and above can create announcements
      allow create: if isAuthenticated() && isClassRepOrAbove();
      
      // Author can update their own announcements
      // Admin+ can update any announcement (for moderation)
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        isAdminOrAbove()
      );
      
      // Only Admin and above can delete announcements
      allow delete: if isAuthenticated() && isAdminOrAbove();
    }
    
    // ==========================================
    // SCHEDULES / ROOMS COLLECTION
    // ==========================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && isFacultyOrAbove();
      allow delete: if isAuthenticated() && isAdminOrAbove();
    }
    
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdminOrAbove();
    }
    
    // ==========================================
    // LOGS COLLECTION (Super Admin Only)
    // ==========================================
    match /logs/{logId} {
      allow read: if isAuthenticated() && isSuperAdmin();
      allow create: if isAuthenticated(); // Any action can create logs
      allow update, delete: if false; // Logs are immutable
    }
    
    // ==========================================
    // SYSTEM SETTINGS (Super Admin Only)
    // ==========================================
    match /settings/{settingId} {
      allow read: if isAuthenticated() && isAdminOrAbove();
      allow write: if isAuthenticated() && isSuperAdmin();
    }
    
    // ==========================================
    // MODERATION FEEDBACK (for Naive Bayes training)
    // ==========================================
    match /moderation_feedback/{feedbackId} {
      allow read: if isAuthenticated() && isAdminOrAbove();
      allow create: if isAuthenticated() && isAdminOrAbove();
      allow update, delete: if isAuthenticated() && isSuperAdmin();
    }
  }
}
